<!doctype html>
<html>
    <head>
        <!-- Load the Paper.js library -->
        <script type="text/javascript" src="js/paper.js"></script>
        <script type="text/javascript" src="js/Track.js"></script>

        <!-- Define inlined PaperScript associate it with myCanvas -->
        <script type="text/paperscript" canvas="myCanvas">
			
			////////// START TRACK GENERATION //////////

			var myTrackConfig = {
					"NumberOfLanes" : 5,
					"NumberOfSegments" : 100,
					"NumberOfInitialOpenSegments" : 5,
					"ObstacleFrequency" : 0.1
				},
				myTrack = new Track(myTrackConfig),
				mySegments = myTrack.getSegments();
			
            ////////// END TRACK GENERATION //////////
			
			
			////////// START TRACK VIEW //////////
			
			// generate OBSTACLES
			var baseObstacle = new Path.Circle({
					center: [0, 0],
					radius: 25,
					fillColor: "black",
					strockColor: "yellow"
				}),
				obstacleSymbol = new Symbol(baseObstacle),
				obstacleLayer;
            
            function createObstacle(x, y) {
                var point = new Point(x + 50, -y),
					placedObstacle = obstacleSymbol.place(point);
            }
			
			function generateObstacles(data) {
                var rowHeight = 100,
                    columnWidth = 100,
                    row;
                for (var y = 0; y < data.length; y++) {
                    row = data[y];
                    for (var x = 0; x < row.length; x++) {
                        switch (row[x]) {
                            case 0: // No Obstacle
                                break;
                            default: // Obstacle
                                createObstacle(x * columnWidth, y * rowHeight);
                                break;
                        }
                    }
                }
            }
			
			generateObstacles(mySegments);
			
			// generate ROAD LINES
			var numberOfRoadRasters = 10,
				roadRasterHeight = 100,
				// calculate combined height to reposition line during onFrame callback
				combinedRoadLineHeight = numberOfRoadRasters * roadRasterHeight * 2,
				// first road line is at bottom of view
				roadLinePosition = new Point(0, view.bounds.height - roadRasterHeight / 2),
				baseRoadLine = new Raster("roadLine", roadLinePosition),
				roadLineSymbol = new Symbol(baseRoadLine);
			
			function checkRoadLine(item) {
				if (view.bounds.y + view.bounds.height < item.bounds.y) {
					item.position.y -= combinedRoadLineHeight;
				}
			}
			
			function createRoadLine(i) {
				var point = roadLinePosition;
				// subsequent lines are positioned above the previous line
				point.y -= roadRasterHeight * 2;
				var placedRoadLine = roadLineSymbol.place(point);
				placedRoadLine.onFrame = function(e) {
					checkRoadLine(this);
				}
			}
			
			function generateRoadLines() {
				for (var i = 0; i < numberOfRoadRasters; i++) {
					createRoadLine(i);
				}
			}
			
			generateRoadLines();
			////////// END TRACK VIEW //////////
			
            var time1;
            
            var numberOfPlayers = 2;
            function createPlayerCar(x, y, color) {
                var racecar = new Rectangle(x, y, 100, 100);
                var path = new Path.Rectangle(racecar);
                
                path.fillColor = color;
                
                return path;
            }
            var player1 = createPlayerCar(100, 500, "green");
            var player2 = createPlayerCar(200, 500, "blue");
            
            function onFrame(event) {
                if (!time1) {
                    time1 = new Date().getTime();
                }
                var time2 = new Date().getTime();
                var delta = time2 - time1;
                time1 = time2;
                //console.log('delta: ' + delta);
                document.getElementById("fps").innerHTML = Math.ceil(1/(delta/1000));
                /*
                //console.log('on frame');
                for (var i = 0; i < numberOfLanes * numberOfLinesPerLane; i++) {
                    var item = project.activeLayer.children[i];
                    
                    item.position.y += item.bounds.height / 2;
                }*/
                var point = new Point(0, -5);
                view.scrollBy(point);
            }
            
            function onKeyDown(e) {
                //console.log('key down: ' + e.key);
                switch(e.key) {
                    case "left":
                        // player2 goes left;
                        var xPos = player2.position.getX() - 100;
                        //console.log(xPos);
                        player2.position.setX(xPos);
                        break;
                    case "right":
                        // player2 goes right;
                        var xPos = player2.position.getX() + 100;
                        player2.position.setX(xPos);
                        break;
                    case "a":
                        // player1 goes left;
                        var xPos = player1.position.getX() - 100;
                        player1.position.setX(xPos);
                        break;
                    case "d":
                        // player1 goes right;
                        var xPos = player1.position.getX() + 100;
                        player1.position.setX(xPos);
                        break;
                    case "down":
                        // zoom in
                        view.zoom += .1;
                        break;
                    case "up":
                        //  zoom out
                        view.zoom -= .1;
                        return false;
                        break;
                }
            }
        </script>
        <style>
            html, body {
                background: white;
                margin: 0;
                padding: 0;
            }
			#canvasWrapper {
				margin: 0 auto;
				width: 502px;
			}
            #myCanvas {
				border: 1px solid black;
				background: grey;
            }
        </style>
    </head>
    <body>
        <p>fps: <span id="fps"></span></p>
        <div id="canvasWrapper"><canvas id="myCanvas" width="500" height="600"></canvas></div>
		<img src="images/road_line2.gif" id="roadLine" />
    </body>
</html>
