<!doctype html>
<html>
    <head>
        <!-- Load the Paper.js library -->
        <script src="js/paper.js"></script>
        <script src="js/Track.js"></script>

        <!-- Define inlined PaperScript associate it with myCanvas -->
        <script type="text/paperscript" canvas="myCanvas">

			////////// START GAME CONTROLLER //////////
			
			var game,
				autoStartGame = false; // for quick debuggin
			
			(function() {
				function GameController() {
				// show game menu
				console.log('show game menu');
				};
				
				GameController.prototype.start = function() {
					console.log('start game');
					this.track = new Track();
					this.camera = new Camera();
					this.player1 = new Player(100, 500, "green", new Point(0,-15));
					this.player2 = new Player(200, 500, "blue", new Point(0,-15));
					this.active = true;
				}
				game = new GameController();
			})();

			////////// END GAME CONTROLLER //////////
			
			////////// START TRACK GENERATION //////////
			(function() {
				function Track() {
					this.data = getTrackData(this.defaults);
					this.createView();
				}
				
				Track.prototype.defaults = {
					"NumberOfLanes" : 5,
					"NumberOfSegments" : 100,
					"NumberOfInitialOpenSegments" : 5,
					"ObstacleFrequency" : 0.1
				};
				
				Track.prototype.createView = function() {
					this.generateObstacles(this.data);
					this.generateRoadLines();
				};
				window.Track = Track;
			})();
			
            ////////// END TRACK GENERATION //////////
			
			
			////////// START OBSTACLES //////////
			
			(function() {
				var baseObstacle = new Path.Circle({
						center: [0, 0],
						radius: 25,
						fillColor: "black",
						strockColor: "yellow"
					}),
					obstacleSymbol = new Symbol(baseObstacle);
				
				function createObstacle(x, y) {
					var point = new Point(x + 50, -y),
						placedObstacle = obstacleSymbol.place(point);
					
					return placedObstacle;
				}
				
				function generateObstacles(data) {
					var rowHeight = 100,
						columnWidth = 100,
						row;
					for (var y = 0; y < data.length; y++) {
						row = data[y];
						for (var x = 0; x < row.length; x++) {
							switch (row[x]) {
								case 0: // No Obstacle
									break;
								default: // Obstacle
									row[x] = createObstacle(x * columnWidth, y * rowHeight);
									break;
							}
						}
					}
				}
				
				window.Track.prototype.generateObstacles = generateObstacles;
			})();
			
			////////// END OBSTACLES //////////
			
			
			////////// START ROAD LINES //////////
			(function() {
				var numberOfRoadRasters = 10,
					roadRasterHeight = 100,
					// calculate combined height to reposition line during onFrame callback
					combinedRoadLineHeight = numberOfRoadRasters * roadRasterHeight * 2,
					// first road line is at bottom of view
					roadLinePosition = new Point(0, view.bounds.height - roadRasterHeight / 2),
					baseRoadLine = new Raster("roadLine", roadLinePosition),
					roadLineSymbol = new Symbol(baseRoadLine);
				
				function checkRoadLine(item) {
					if (view.bounds.y + view.bounds.height < item.bounds.y) {
						item.position.y -= combinedRoadLineHeight;
					}
				}
				
				function createRoadLine(i) {
					var point = roadLinePosition;
					// subsequent lines are positioned above the previous line
					point.y -= roadRasterHeight * 2;
					var placedRoadLine = roadLineSymbol.place(point);
					placedRoadLine.onFrame = function(e) {
						checkRoadLine(this);
					}
				}
				
				function generateRoadLines() {
					for (var i = 0; i < numberOfRoadRasters; i++) {
						createRoadLine(i);
					}
				}
				
				window.Track.prototype.generateRoadLines = generateRoadLines;
			})();
			
			////////// END ROAD LINES //////////
			
			
			////////// START CAMERA //////////
			(function() {
				function Camera() {
					this.zoomBlocked = false;
					this.bottomPadding = 100;
				
					this.repositionCamera = function() {
						var avg = (game.player1.path.position/2 + game.player2.path.position/2);
						avg.y -= view.bounds.height / 4;
						var viewBottomPadding = new Rectangle(view.bounds.x, view.bounds.y, view.bounds.width, view.bounds.height - this.bottomPadding);
						while(!(view.bounds.contains(game.player1.path.bounds) && view.bounds.contains(game.player2.path.bounds))) {
							zoomOut();
						} 
						if (viewBottomPadding.contains(game.player1.path.bounds) && viewBottomPadding.contains(game.player2.path.bounds)) {
							zoomIn();
						}
						
						view.center = avg;
					}
					
					function blockZoomIn() {
						this.zoomBlocked = true;
						setTimeout(function() {this.zoomBlocked = false;}, 700);
					}
					
					function zoomOut() {
						view.zoom -= .01;
						blockZoomIn();
					}
					
					function zoomIn() {
						if (!this.zoomBlocked) {
							view.zoom += .01;
						}
					}
					return this;
				}
				window.Camera = Camera;
			})();
			
			////////// END CAMERA //////////

			////////// START PLAYER //////////
			
			(function() {
				function Player(x, y, color, initialVelocity) {
					var self = this;
					var racecar = new Rectangle(x, y, 100, 100);
					
					var path = new Path.Rectangle(racecar);
					
					path.fillColor = color;

					self.shape = racecar;
					self.velocity = initialVelocity;
					self.path = path;
					self.moveForward = function(tickDuration) {
						if(!tickDuration) {
							var tickDuration = 30;
						}
						self.path.position += self.velocity; //* tickDuration / 50;
					}
					self.collideWith = function(obstacle) {
						var collisionVelocity = new Point(0,5);
						self.velocity += collisionVelocity;
						setTimeout(function() { self.velocity -= collisionVelocity },500);
						
					}
					return this;
				}
				window.Player = Player;
			})();
			
			////////// END PLAYER //////////
			
            var time1;
            function onFrame(event) {
                if (!time1) {
                    time1 = new Date().getTime();
                }
                var time2 = new Date().getTime();
                var delta = time2 - time1;
                time1 = time2;
                document.getElementById("fps").innerHTML = Math.ceil(1/(delta/1000));
                
				if (game.active || autoStartGame) {
					game.player1.moveForward(delta);
					game.player2.moveForward(delta);
					
					game.camera.repositionCamera();
				}
            }
            
            function onKeyDown(e) {
                switch(e.key) {
                    case "left":
						// player2 goes left;
						var xPos = game.player2.path.position.getX() - 100;
						game.player2.path.position.setX(xPos);
						return false;
						break;
					case "right":
						// player2 goes right;
						var xPos = game.player2.path.position.getX() + 100;
						game.player2.path.position.setX(xPos);
						return false;
						break;
					case "a":
						// player1 goes left;
						var xPos = game.player1.path.position.getX() - 100;
						game.player1.path.position.setX(xPos);
						break;
					case "d":
						// player1 goes right;
						var xPos = game.player1.path.position.getX() + 100;
						game.player1.path.position.setX(xPos);
						break;
					case 'g':
						game.player1.collideWith();
						break;
					case 'h':
						game.player2.collideWith();
						break;
                }
            }
			
			document.getElementById("start").onclick = function() {
				game.start();
				return false;
			}
			if (autoStartGame) {
				game.start();
			}
        </script>
		<style>
            html, body {
                background: white;
                margin: 0;
                padding: 0;
            }
			#canvasWrapper {
				margin: 0 auto;
				width: 502px;
			}
            #myCanvas {
				border: 1px solid black;
				background: grey;
            }
        </style>
    </head>
    <body>
		<h1>Ten 2nd's</h1>
		<p>fps: <span id="fps"></span></p>
        <div id="canvasWrapper"><canvas id="myCanvas" width="500" height="600"></canvas></div>
		<img src="images/road_line2.gif" id="roadLine" />
		
		<div id="gameMenu">
			<a id="start" href="">Start new game</a>
		</div>
    </body>
</html>
