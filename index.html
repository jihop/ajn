<!doctype html>
<html>
	<head>
		<!-- Load the Paper.js library -->
		<script type="text/javascript" src="js/paper.js"></script>
		<!-- Define inlined PaperScript associate it with myCanvas -->
		<script type="text/paperscript" canvas="myCanvas">
			
			function createRoadLine(color) {
				// Create a Paper.js Path to draw a line into it:
				var path = new Path();
				// Give the stroke a color
				path.strokeColor = color;
				var start = new Point(100, 100);
				// Move to start and draw a line from there
				path.moveTo(start);
				// Note the plus operator on Point objects.
				// PaperScript does that for us, and much more!
				path.lineTo(start + [ 0, -50 ]);
				return path;
			}
			
			var numberOfLanes = 5;
			var numberOfLinesPerLane = 50;
			var line = createRoadLine("yellow");
			var symbol = new Symbol(line);
			var minVelocity = new Point(0,-10);
			var camera = new Camera();
			
			for(var x = 0; x < numberOfLanes; x++) {
				for(var y = 0; y < numberOfLinesPerLane; y++) {
					//console.log('place a new line: ' + x * 100 + " " + y * -50);
					var position = new Point(x * 100, -(y * 50 + y * 100));
					//console.log(position);
					var placedLine = symbol.place(position);
				}
			}
			
			var time1;
			
			
			function onFrame(event) {
				if (!time1) {
					time1 = new Date().getTime();
				}
				var time2 = new Date().getTime();
				var delta = time2 - time1;
				time1 = time2;
				//console.log('delta: ' + delta);
				document.getElementById("fps").innerHTML = Math.ceil(1/(delta/1000));
				//console.log('on frame');
				
				// Animate players
				
				
				player1.moveForward(delta);
				player2.moveForward(delta);
				
				camera.repositionCamera();
			}
			
			var numberOfPlayers = 2;
			
			function Camera() {
				this.zoomBlocked = false;
				this.bottomPadding = 100;
			
			    this.repositionCamera = function() {
					var avg = (player1.path.position/2 + player2.path.position/2);
					avg.y -= view.bounds.height / 4;
					var viewBottomPadding = new Rectangle(view.bounds.x, view.bounds.y, view.bounds.width, view.bounds.height - this.bottomPadding);
					while(!(view.bounds.contains(player1.path.bounds) && view.bounds.contains(player2.path.bounds))) {
						zoomOut();
					} 
					if (viewBottomPadding.contains(player1.path.bounds) && viewBottomPadding.contains(player2.path.bounds)) {
						zoomIn();
					}
					
					view.center = avg;
				}
				
				function blockZoomIn() {
					this.zoomBlocked = true;
					setTimeout(function() {this.zoomBlocked = false;}, 700);
				}
				
				function zoomOut() {
					view.zoom -= .01;
					blockZoomIn();
				}
				
				function zoomIn() {
					if (!this.zoomBlocked) {
						view.zoom += .01;
					}
				}
				return this;
			}
			
			

			
			function Player(x, y, color, initialVelocity) {
				var self = this;
				var racecar = new Rectangle(x, y, 100, 100);
				
				var path = new Path.Rectangle(racecar);
				
				path.fillColor = color;

				self.shape = racecar;
				self.velocity = initialVelocity;
				self.path = path;
				self.moveForward = function(tickDuration) {
					if(!tickDuration) {
						var tickDuration = 30;
					}
					self.path.position += self.velocity; //* tickDuration / 50;
				}
				self.collideWith = function(obstacle) {
					var collisionVelocity = new Point(0,5);
					self.velocity += collisionVelocity;
					setTimeout(function() { self.velocity -= collisionVelocity },500);
					
				}
				return this;
			}
			var player1 = new Player(100, 500, "green", new Point(0,-15));
			var player2 = new Player(200, 500, "blue", new Point(0,-15));
			//console.log(player1.position);
			
			function onKeyDown(e) {
				//console.log('key down: ' + e.key);
				switch(e.key) {
					case "left":
						// player2 goes left;
						var xPos = player2.path.position.getX() - 100;
						//console.log(xPos);
						player2.path.position.setX(xPos);
						break;
					case "right":
						// player2 goes right;
						var xPos = player2.path.position.getX() + 100;
						player2.path.position.setX(xPos);
						break;
					case "a":
						// player1 goes left;
						var xPos = player1.path.position.getX() - 100;
						player1.path.position.setX(xPos);
						break;
					case "d":
						// player1 goes right;
						var xPos = player1.path.position.getX() + 100;
						player1.path.position.setX(xPos);
						break;
					case 'g':
						player1.collideWith();
						break;
					case 'h':
						player2.collideWith();
						break;
				}
				
			}
		</script>
		<style>
			html, body {
				background: white;
				margin: 0;
				padding: 0;
			}
			#myCanvas {
				background: grey;
				margin: 20px;
			}
		</style>
	</head>
	<body>
		<p>fps: <span id="fps"></span></p>
		<canvas id="myCanvas" width="500" height="600"></canvas>
	</body>
</html
